日志分析服务（LogDB）提供针对日志类数据的存储、检索与分析服务，同时具备监控与报警功能，帮助用户提升运维、运营效率，快速查找和定位问题，如排查服务器障碍、在线业务监控、应用程序Bug跟踪分析等。

![](http://docs.qiniucdn.com/logdb.png)

## 概念&术语

```
  repo       fields       analyzer       retention      
```

### 日志仓库（repo）

日志仓库集中保存了我们从实时数据仓库导入的日志，支持多种数据类型以及多种索引方式，支持基于文本的搜索、过滤和分析。

### 字段（fields）

在日志分析服务中，数据字段支持的类型有以下几种：

|类型|解释|数据样例|
|:--|:--|:--|
|long|64位整数|998|
|float|单精度64位浮点|10.24|
|date|日期类型，默认格式为RFC3339，可自定义格式|`2017-01-01T15:00:25Z07:00`|
|string|字符串类型，可设置分词器和主键|"qiniu.com"|
|boolean|布尔类型，值为true或false|false|
|object|json格式|-|
|ip|ip地址|127.0.0.1|
|geo_point|经纬度坐标|[ -71.34, 41.12 ]|

#### 索引方式

日志分析服务最大的优势在于可以对字符串类型的数据进行倒排索引，可以使用搜索引擎的技术对于日志进行索引，并且支持各种灵活的搜索方式。其中索引的方式包括两种：

**分字段索引**

分字段索引可以允许用户挑选字符串字段，选择灵活的分词和索引方式。可以参考文末的Lucene语法（如 log:Error 代表在log字段中搜索Error单词）
对数据进行搜索、过滤和分析。使用分字段索引的时候可以指定仅仅对某些字段进行分词，降低存储成本，提高写入和检索效率。

![](https://pandora-kibana.qiniu.com/logdb/%E5%88%86%E5%AD%97%E6%AE%B5%E6%9F%A5%E8%AF%A2.png)

**全文索引**

全文索引指定一种固定的分词索引方式，为所有的字段创建跨字段的索引。使用全文索引使您在检索的时候直接输入文本即可搜索，
不需要像分字段索引一样需要指定查询字段。如果您的字段特别繁多，或者字段是非常复杂的嵌套结构，此时选择全文索引搜索会更加便利和灵活。
不过要注意：全文索引会增加存储成本，而且无法挑选字段进行索引，也无法为字段设置单独的分词器。
 
![](https://pandora-kibana.qiniu.com/logdb/%E5%85%A8%E6%96%87%E7%B4%A2%E5%BC%95.png)

### 分词方式（analyzer）

您可以根据自己的搜索习惯和需求，对日志中的field设置分词方式，目前日志分析服务提供以下几种分词方式：

**不分词**

不分词的含义其实是“keyword分词”，意思就是，你必须完整的输入某一个field的内容，才能被搜索到，我们举个例子来说明：

```
假设目前有1个field为A，它的内容是"abcdefg"
假设我们选择了不分词方式，那么如果想搜索到这一条内容，需要在条件框输入：
A:"abcdefg"
这样才能搜索到，如果我们按照以下几种方式，则无法搜索到：
A:"a"
A:"abc"
A:"edf"
```

**不分词不索引**

不分词不索引的含义是指：在任何情况下，输入任何条件，都不会搜索到该field的内容，但在搜索其他field时，如果是整条搜索，那么这个field的内容也会显示出来。

```
假设现在有2个field，分别为：
A:"abcdefg",B:"12345678"
无论我们在条件框输入有关B的任何条件，都不会搜索到
```

**标准分词**

以unicode字符作为结束的标识，过滤掉大部分标点符号，将所有字母变为小写，搜索时只要符合搜索条件的词语出现，就会被搜索到。

```
假设现在有1个field为A，它的内容是"linux-chrome,what's your&name?"
那么使用标准分词，将会被分为："linux,chrome,what's,your,name"
我们的搜索条件包含这些词时，会被搜索到
```
!> 注意：标准分词只适用于全英文字符的field。

**空白分词**

以单词头部和尾部的空格作为分割条件，输入两个空格内的完整内容，即可搜索到相应内容。

```
例：
A="张三 李四 王五"

需要输入以下条件，均可搜到内容：
A:"张三"
A:"李四"
A:"王五"

如果输入以下条件，则无法搜索到内容：
A:"张"
A:"张三 李四"
```

**path分词**

以linux系统路径来进行分词，当搜索时，可以输入完整的路径或者路径前缀来进行匹配，如果输入的条件不是一个正确的前缀，那么将无法正确呈现日志内容。

```
例：
filed A="/usr/local/action.log"

那么需要输入以下条件，均可搜到内容：
A:"/usr"
A:"/usr/local"
A:"/usr/local/action.log"

如果输入以下条件，则无法搜索到内容：
A:"/u"
A:"usr"
A:"/action.log"
```

### 存储时限（retention）

创建仓库时，我们需要指定这个属性，它的意思是指这个仓库内的每一条日志都会被存储和retention一致的天数，超过这个时间的数据会被自动删除，当retention指定为0时，表示永久存储。


## 实时日志输出

实时数据仓库集中存储了从服务器、终端设备、日志收集器等多种途径收集来的日志，我们支持对数据源和消息队列中的日志进行实时滚动输出，毫秒级延迟支持用户第一时间获得信息。

同时实时输出功能支持条件过滤，在海量实时日志中筛选核心数据，滚动展示。

![](https://pandora-kibana.qiniu.com/%E5%AE%9E%E6%97%B6%E6%97%A5%E5%BF%97.png)

同时实时仓库支持前往工作流进行数据导出，支持将实时数据导出到日志仓库、云存储、时序数据库等多种下游数据仓库，与工作流协同工作，您可以高效地进行实时日志的查询与计算，一鼓作气完成实时日志的整个分析流程。

![](https://pandora-kibana.qiniu.com/%E5%AE%9E%E6%97%B6%E6%97%A5%E5%BF%97-%E5%B7%A5%E4%BD%9C%E6%B5%81.png)


注意：如果实时日志数据量过大，每次滚动输出日志的时候会限制在1000条进行展示。避免页面数据过大导致无法展示。

## 搜索


搜索界面由搜索栏、仓库列表栏、搜索历史栏组成，通过这三大块您可以完成高效又精细的搜索。

![](https://pandora-kibana.qiniu.com/search_interface1.png)

在搜索栏您可以通过选择日志仓库、输入查询语句、选择时间范围来搜索日志。如果日志仓库里面包含时间字段，您可以通过选择时间字段来过滤搜索结果。

### 快速搜索

您可以通过搜索界面的仓库列表快速查询具体某个仓库的全部日志,也可以通过搜索历史快速定位已经做过的搜索，避免重复工作。

![](https://pandora-kibana.qiniu.com/quick_search.png)

### 搜索统计视图

搜索模式分为两种，极速模式和详细模式。当您想要看到日志结果随时间的具体统计图时，可以选择详细模式搜索。统计视图显示随时间统计的日志事件数量。点击直方图的任何部分都可以选择那个时间段以查看选定时间范围内的事件。

![](https://pandora-kibana.qiniu.com/histogram4.png)

### 字段过滤

日志的field列表显示在搜索结果的左侧，默认情况下搜索结果会显示日志的全部字段，您可以通过字段筛选添加您想查看的字段显示到右侧的日志详细内容中。

![](https://pandora-kibana.qiniu.com/choose.png)

### 字段统计分析报表

Logdb支持字段统计分析，在搜索结果左侧字段列表，每个字段会有统计基数显示，点击以后您可以看到字段的具体统计信息，如最大值、最小值、平均值、字段覆盖率、出现频率为TOP10的值的相关信息等，并推荐您可能感兴趣的关键值，点击关键值即可快速搜索出包含该关键值的日志。

![](https://pandora-kibana.qiniu.com/field_analysis3.png)

并且，您可以看到字段的罕见值（出现次数比较少的值）、高频值（出现次数比较多的值）、时序平均值(字段平均值随时间的统计图）、时序最大值、时序最小值等几种值的统计图表以及查看包含某具体字段的全部日志。

![](https://pandora-kibana.qiniu.com/high_frequency.png)

![](https://pandora-kibana.qiniu.com/time_series_average.png)

字段统计分析功能帮助您高效地进行日志查询，指引您挖掘更有价值的日志信息。

### 日志结果显示

Logdb支持三种日志显示模式，`JSON`、`文档`和`表格`，您可以根据自己的阅读习惯任意切换。

![](https://pandora-kibana.qiniu.com/log_pattern.png)


### 划词分析

logdb支持搜索结果的划词分析，对搜索结果进行过滤。您可以提取日志结果里的关键字段，选择“加入搜索”，结果会过滤出包含这些关键字段的日志事件，可以同时对多个关键字段划词分析。您可以看到搜索框自动出现了查询语句，大大节省了您的工作量。

![](https://pandora-kibana.qiniu.com/line.png)

### 联合搜索

logdb支持多个日志仓库联合搜索，如果您拥有多个日志仓库，这几个仓库里的数据彼此关联，您可以同时选择若干个仓库进行联合搜索，获得更全面的分析结果。

![](https://pandora-kibana.qiniu.com/union2.png)

### 搜索语法

日志分析服务提供Lucene、SQL共2种语法来进行日志搜索，但需要注意，一旦有任何数据包含以下符号，无论使用哪种语法，在搜索时，需要以`双引号（""）`包含起来：

```
+  -  
&&  ||  !
( )  { }  [ ] 
^  ”  ~  *  ?  :  \
```


#### 使用 lucene 语法搜索

**条件编写规范**

|名称|语义|
|:--|:--|
|*|查询所有内容|
|AND|query1 AND query2，查询交集|
|OR	|query1 OR query2，查询并集|
|NOT|query1 AND NOT query2，表示符合query1，不符合query2的结果|
|()	|把一个或多个query合并成一个query，提升优先级|
|[]	|区间查询，包括边界|
|{}|区间查询，不包括边界|
|\|转义字符|
|>,=,<,<=,>=|区间查询|

**正则表达式查询**

正则表达式查询条件编写时，以`"/"`开头和结尾。

比如：`name:/joh?n(ath[oa]n)/`

**通配符查询**

使用`?`代替一个字符，`*`代替0或者多个字符

比如：`qu?ck bro*`

* 注意使用这个查询会消耗大量资源，并且速度会降低。


**查询举例：**

字段名称`name`，类型`string`，包含内容`a`的记录：

?>name:a

字段名称`ip`，类型`string`，包含内容`a`或`b`的记录：

?>ip:a OR ip:b

字段名称`hosts`，类型`string`，包含内容`a`或者`b`,不包含`c`的记录：

?>(hosts:a OR hosts:b) AND (NOT hosts:c)

字段名称`ip`，类型`string`，包含内容`a`或`b`，同时字段名称`hosts`，类型`string`，包含内容`c`的记录：

?>(ip:a OR ip:b) AND (hosts:c)

字段名称`createTime`，类型`date`，包含内容`2016-1-1`到`2016-1-2`的记录：

?>createTime:[2016-01-01 TO 2016-01-02]

字段名称`count`，类型`long`或者`float`，内容大于5的记录： 

?>count:>5

更多高级语法和使用方式请参考Lucene Query。

## 仓库配置导入导出

在仓库管理界面，您可以导入本地JSON文件，导入成功以后系统会自动打开创建仓库页面，并且字段全部自动添加。

![](https://pandora-kibana.qiniu.com/json.png)

![](https://pandora-kibana.qiniu.com/json_import.png)

同样，您也可以导出仓库的配置到本地保存，下次如果您想创建同类型Schema的仓库，使用导入功能即可。

通过`导入`和`导出`功能相结合，您可以精准快速地创建数据仓库，省去重复工作。

![](https://pandora-kibana.qiniu.com/import.png)

## 报警

报警是logdb新上线的功能，帮您监控日志数据。您只需要设置好报警指标、报警阈值等，当满足触发条件时，通过`HTTP接口回调`、`邮件提醒`、`短信提醒`这三种方式，系统会给您发送报警相关信息，提醒您日志哪里出现了异常。

### 配置报警

单击搜索栏下面的“另存为告警”，开始配置报警项。

在报警设置页面，您需要填写以下信息：

![](https://pandora-kibana.qiniu.com/warn_setting_new.png)

这是一条名称是“响应时间平均数大于1秒报警“的报警配置，它的意思是：每隔1分钟检测最近10分钟内的日志内容，request_time这个字段的平均值如果超过1就触发报警，且15分钟内即使满足报警条件也只触发一次报警。

**运行周期**

您可以设置每隔多久检测一次日志内容报警。

**查询时间**
 
 设定一个查询的时间范围，只针对这个时间范围内的日志检测报警。
 
**分组字段 报警指标 报警阈值**

您可以通过这三条信息创建报警触发条件，其中您可以通过分组字段对数据进行分组，对每个分组的数据分别监控报警指标。通过自由组合，您可以创建以下两种报警触发条件：

1.按事件总数报警

报警指标选择事件总数，给定一个触发报警的阈值。例如，您可以设置报警条件为10分钟内根据machine分组的日志事件总数超过100：

![](https://pandora-kibana.qiniu.com/warn06.png)

2.按字段统计数报警

在报警指标里选择统计方式（总和、平均值、最大值、最小值、中位数、分位数），紧跟其后选择字段名，例如，告警触发条件为：根据machine字段分组的日志数据里，request_time在10分钟之内的平均值大于1:

![](https://pandora-kibana.qiniu.com/warn07.png)

**报警限制** 

防止您在短时间内遭遇报警轰炸，您可以设置一个固定时间段，在该时间段内出发告警后，系统不再重复发送同类告警信息。

**报警类型**

* logdb支持HTTP接口回调报警方式，添加能接受请求的地址，logdb会发送告警内容到该地址，提醒您日志哪里出现了异常。同时可以在HTTP请求中增加自定义的Header，用来完成例如鉴权等多种高级需求。请求方式为HTTP POST请求，请求体格式如下：

```
{
	"alert": "alert",  // alert 名字
	"time": "2018-03-06 14:15:52",  // 报警时间
	"metrics": [{
		"buckets": { // 每个分组的详细信息
			"groupId": "分组1"  // groupId 字段为 分组1 
		},
		"value": 137543.0, // 分组的统计值
		"abnormal": true   // 是否出现异常，true为异常，false为正常
	}, {
		"buckets": {
			"groupId": "分组2"
		},
		"value": 69610.0,
		"abnormal": true
	}]
}
```

* 邮件报警：支持发送邮件到指定多个邮箱内进行报警。邮件包含了报警的异常信息，以及可能的相关日志。

![](https://pandora-kibana.qiniu.com/email-alert.png)


* 短信报警：短信报警可以指将报警时的简略信息发送到用户手机上，随时随地掌握系统健康状况。

```
尊敬的七牛云用户，您的日志服务名称：metrictype分组处理数据报警
（描述：统计每个metrictype分组，正在处理的数据总量）出现异常。
metrictype分组含有3个异常分组，例如分组值为http的当前指标
【sum(success)】值为 386.0 小于等于报警阈值【3000.0】。
详情敬请登录七牛云查看。【七牛云服务】
```


**测试**

填好配置项以后，您可以点击测试规则测试一下报警设置是否生效。

![](https://pandora-kibana.qiniu.com/warn_test.png)

!> 注意：每个账号暂时最多只支持创建5条报警。如果需要额外创建报警，请与管理员联系。

都设置好以后，您就可以让logdb帮您监控数据啦！


